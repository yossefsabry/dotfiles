#!/bin/bash

set -euo pipefail

DEFAULT_QUALITY=480

# ---------------------------
# Clipboard helper
# ---------------------------
get_clipboard() {
    if [ "${XDG_SESSION_TYPE:-}" = "wayland" ]; then
        wl-paste
    else
        xclip -o -selection clipboard
    fi
}

# ---------------------------
# Parse args
# ---------------------------
URL=""
REQ_QUALITY=""

if [ -n "${1:-}" ] && [[ "${1:-}" =~ (youtube\.com|youtu\.be) ]]; then
    URL="$1"
    REQ_QUALITY="${2:-$DEFAULT_QUALITY}"
else
    URL="$(get_clipboard)"
    REQ_QUALITY="${1:-$DEFAULT_QUALITY}"
fi

# ---------------------------
# Validate
# ---------------------------
if [[ ! "$URL" =~ (youtube\.com|youtu\.be) ]]; then
    echo "Not a YouTube URL"
    exit 1
fi

# ---------------------------
# Build quality ladder
# ---------------------------
case "$REQ_QUALITY" in
    360) QLIST="360p" ;;
    480) QLIST="480p,360p" ;;
    720) QLIST="720p,480p,360p" ;;
    1080) QLIST="1080p,720p,480p,360p" ;;
    *) echo "Invalid quality"; exit 1 ;;
esac

# ---------------------------
# Try Streamlink (probe only)
# ---------------------------
AVAILABLE=$(streamlink "$URL" 2>/dev/null | grep -oE '[0-9]+p' || true)

if echo "$AVAILABLE" | grep -qE '480p|720p|1080p'; then
    echo "▶ Using Streamlink"
    streamlink \
        --player mpv --player-no-close \
        "$URL" "$QLIST"
    exit 0
fi

# ---------------------------
# Fallback: mpv + yt-dlp
# ---------------------------
echo "▶ Using mpv (yt-dlp backend)"

mpv \
  --ytdl-format="bestvideo[height<=$REQ_QUALITY]+bestaudio/best" \
  "$URL"

