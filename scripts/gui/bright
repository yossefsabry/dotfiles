#!/usr/bin/env bash

checkCommand() {
    command -v "$1" &> /dev/null
}

setBrightness() {
    local action="$1"
    local min_percent=5
    local min_value
    local cur_value
    local max_value
    local new_value
    local step_value

    getBrightnessInfo() {
        max_value=$(brightnessctl max)
        cur_value=$(brightnessctl get)
        min_value=$(( (max_value * min_percent + 99) / 100 ))
        if [[ $min_value -lt 1 ]]; then
            min_value=1
        fi
    }

    clampValue() {
        local value="$1"
        if [[ $value -lt $min_value ]]; then
            echo "$min_value"
            return 0
        fi
        if [[ $value -gt $max_value ]]; then
            echo "$max_value"
            return 0
        fi
        echo "$value"
        return 0
    }

    if checkCommand brightnessctl; then
        getBrightnessInfo
        step_value=$(( (max_value * 15 + 50) / 100 ))
        case "$action" in
            up)
                new_value=$(( cur_value + step_value ))
                new_value=$(clampValue "$new_value")
                brightnessctl set "$new_value" > /dev/null
                ;;
            down)
                new_value=$(( cur_value - step_value ))
                new_value=$(clampValue "$new_value")
                brightnessctl set "$new_value" > /dev/null
                ;;
            *)
                if [[ "$action" =~ ^[0-9]+%$ ]]; then
                    new_value=${action%%%}
                    new_value=$(( (max_value * new_value + 50) / 100 ))
                    new_value=$(clampValue "$new_value")
                    brightnessctl set "$new_value" > /dev/null
                elif [[ "$action" =~ ^[0-9]+$ ]]; then
                    new_value=$action
                    new_value=$(clampValue "$new_value")
                    brightnessctl set "$new_value" > /dev/null
                else
                    cecho "Invalid argument. Use 'up', 'down', or a percentage (e.g., 50%)." red
                    exit 1
                fi
                ;;
        esac
    else
        cecho "brightnessctl not found." red
        cecho "Installing brightnessctl..." blue
        if sudo pacman -S --noconfirm brightnessctl; then
            setBrightness "$action"
        else
            cecho "Failed to install brightnessctl." red
            exit 1
        fi
    fi
}

if [[ $# -eq 0 ]]; then
    brightnessctl
    exit 0
fi

setBrightness "$1"
